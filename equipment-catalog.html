<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Каталог оборудования — KALIPSO</title>
  <link rel="stylesheet" href="/css/variables.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/catalog-hero.css" />
  <link rel="stylesheet" href="/css/equipment-catalog.css" />
</head>
<body>
  <header class="header"></header>
  <script src="/js/header.js"></script>
  <script src="/js/url-rewrite.js"></script>
  <main>
    <section class="section-simple equipment-catalog-page">
      <div class="container">
        <nav class="equipment-catalog-page__breadcrumbs" id="breadcrumbs">
          <a href="index.html">Главная</a> / <a href="equipment.html">Оборудование</a> / <span id="breadcrumb-category">Фильтрация</span>
        </nav>
        <div class="equipment-catalog-page__header">
          <h1 class="equipment-catalog-page__title" id="category-title">Фильтрация</h1>
          <p class="equipment-catalog-page__subtitle" id="category-subtitle">Фильтры и установки. Подбор по объёму и гидравлике.</p>
        </div>

        <div class="equipment-catalog-intro" id="catalog-intro">
          <p class="equipment-catalog-intro__text">Как выбрать: подбор по объёму чаши и гидравлике трассы. Что влияет на цену: диаметр, материал корпуса, наличие насоса. Уточним бесплатно: совместимость с вашей схемой и актуальные сроки поставки.</p>
        </div>

        <div class="equipment-catalog-sticky-cta">
          <p class="equipment-catalog-sticky-cta__text" id="sticky-cta-text">Не уверены? Подберём оборудование под объём чаши за 15 минут.</p>
          <a href="#callback" class="btn btn-primary">Подобрать оборудование</a>
        </div>

        <div class="equipment-catalog-layout">
          <aside class="equipment-filters" id="filters-sidebar" role="region" aria-label="Фильтры каталога">
            <h3 class="equipment-filters__title">Фильтры</h3>
            <div class="equipment-filters__group">
              <label class="equipment-filters__label" for="filter-brand">Бренд</label>
              <select id="filter-brand" class="equipment-filters__select">
                <option value="">Все бренды</option>
              </select>
            </div>
            <div class="equipment-filters__group">
              <label class="equipment-filters__label" for="filter-diameter">Диаметр (Ø)</label>
              <select id="filter-diameter" class="equipment-filters__select">
                <option value="">Все</option>
              </select>
            </div>
            <div class="equipment-filters__group">
              <label class="equipment-filters__label" for="filter-connection">Подключение</label>
              <select id="filter-connection" class="equipment-filters__select">
                <option value="">Все</option>
              </select>
            </div>
            <div class="equipment-filters__group">
              <label class="equipment-filters__label" for="filter-perf">Производительность</label>
              <select id="filter-perf" class="equipment-filters__select">
                <option value="">Все</option>
              </select>
            </div>
          </aside>

          <div class="equipment-catalog-main">
            <button type="button" class="equipment-filters-toggle" id="filters-toggle" aria-expanded="false" aria-controls="filters-sidebar">
              Фильтры
            </button>
            <div class="equipment-catalog-bar">
              <span class="equipment-catalog-count" id="products-count">Найдено: 0</span>
              <div class="equipment-catalog-sort">
                <select id="sort-select">
                  <option value="popular">Популярные</option>
                  <option value="price-asc">По цене: дешевле</option>
                  <option value="price-desc">По цене: дороже</option>
                  <option value="brand">По бренду</option>
                </select>
              </div>
              <div class="equipment-catalog-chips" id="chips-row">
                <button type="button" class="equipment-catalog-chip-reset" id="chips-reset" style="display:none;">Сбросить</button>
              </div>
            </div>

            <div id="products-filtration" class="equipment-catalog-page__products">
              <div class="equipment-product-grid" id="grid-filtration"></div>
              <p class="equipment-catalog-page__empty" id="empty-filtration" style="display:none;">В этой категории пока нет товаров. <a href="#callback">Напишите нам</a> — подберём оборудование под ваш бассейн.</p>
            </div>

            <div id="products-heating" class="equipment-catalog-page__products" hidden>
              <div class="equipment-product-grid" id="grid-heating"></div>
              <p class="equipment-catalog-page__empty" id="empty-heating" style="display:none;">В этой категории пока нет товаров. <a href="#callback">Напишите нам</a> — подберём оборудование под ваш бассейн.</p>
            </div>

            <div id="products-automation" class="equipment-catalog-page__products" hidden>
              <div class="equipment-product-grid" id="grid-automation"></div>
              <p class="equipment-catalog-page__empty" id="empty-automation" style="display:none;">В этой категории пока нет товаров. <a href="#callback">Напишите нам</a> — подберём оборудование под ваш бассейн.</p>
            </div>

            <div id="products-attractions" class="equipment-catalog-page__products" hidden>
              <div class="equipment-product-grid" id="grid-attractions"></div>
              <p class="equipment-catalog-page__empty" id="empty-attractions" style="display:none;">В этой категории пока нет товаров. <a href="#callback">Напишите нам</a> — подберём оборудование под ваш бассейн.</p>
            </div>

            <div class="equipment-catalog-cta">
              <a href="equipment.html" class="btn btn-outline">Все категории</a>
              <a href="#callback" class="btn btn-primary">Подобрать комплект</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <section class="footer-cta callback callback--blue" id="callback">
    <div class="container">
      <div class="callback__glass">
        <div class="callback__text">
          <h2 class="callback__title">Нужна консультация по оборудованию?</h2>
          <p class="callback__desc">Подскажем оптимальный комплект под ваш бассейн, задачи и бюджет. Без переплаты и лишних элементов.</p>
          <p class="callback__hint">Бесплатно. Перезвоним за 15 минут.</p>
        </div>
        <div class="callback__form-wrap">
          <form action="#" method="get" class="callback__form">
            <div class="callback__form-row">
              <input type="tel" name="phone" class="callback__input" placeholder="+7 (___) ___-__-__" required />
              <button type="submit" class="btn btn-gold callback__btn">Перезвонить мне</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="footer__grid">
        <div>
          <h4 class="footer__title">Каталог</h4>
          <ul class="footer__links">
            <li><a href="catalog.html">Бассейны</a></li>
            <li><a href="equipment.html">Оборудование</a></li>
          </ul>
        </div>
        <div>
          <h4 class="footer__title">Компания</h4>
          <ul class="footer__links">
            <li><a href="services.html">Услуги</a></li>
            <li><a href="about.html">О компании</a></li>
            <li><a href="contacts.html">Контакты</a></li>
          </ul>
        </div>
        <div>
          <h4 class="footer__title">Контакты</h4>
          <p style="margin:0;">+7 (495) 123-45-67</p>
          <p style="margin:4px 0 0;">info@kalipso.ru</p>
        </div>
      </div>
      <div class="footer__bottom">
        © 2025 KALIPSO. Проектирование и строительство бассейнов. Москва и область.
      </div>
    </div>
  </footer>
  <script src="/data/equipment-products.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/lead-form.js"></script>
  <script>
    (function() {
      var API_BASE = window.EQUIPMENT_API_BASE !== undefined ? window.EQUIPMENT_API_BASE : (window.location.protocol === 'file:' ? 'http://127.0.0.1:8000' : '');
      var catKeys = ['filtration', 'heating', 'automation', 'attractions'];
      var subTitles = window.EQUIPMENT_CATEGORY_SUBTITLES || {};

      function esc(s) { return (s || '').replace(/</g, '&lt;').replace(/"/g, '&quot;'); }
      function formatPrice(val) {
        if (!val) return '';
        var s = String(val).replace(/\s/g, '');
        if (/^\d+$/.test(s)) {
          return s.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
        return val;
      }

      function parseProductFilters(p) {
        var d = null, c = null, perf = null, type = 'filter';
        var text = [].concat(p.cardSpecs || [], [p.model || '', p.shortTitle || '', p.title || '']).join(' ');
        if (/\Ø(\d+)/.test(text)) d = text.match(/\Ø(\d+)/)[1];
        if (/Подкл\.\s*([^\s·]+)/.test(text)) c = text.match(/Подкл\.\s*([^\s·]+)/)[1].trim();
        else if (/(\d+)\s*мм/.test(text)) c = text.match(/(\d+)\s*мм/)[0];
        else if (/1½|1½″/.test(text)) c = '1½″';
        if (/(\d+)\s*м³\/ч/.test(text)) perf = text.match(/(\d+)\s*м³\/ч/)[1];
        if (/установка/.test(text)) type = 'filter-unit';
        else if (/без насоса/.test(text)) type = 'without-pump';
        else if (/с насосом/.test(text)) type = 'with-pump';
        return { diameter: d, connection: c, perf: perf, type: type };
      }

      function assetUrl(u) { return !u ? '' : (u.startsWith('/') || u.startsWith('http')) ? u : '/' + u.replace(/^\/?/, ''); }
      function buildCard(p) {
        var title = p.shortTitle || p.title || '';
        var model = p.model || '';
        var specs = p.cardSpecs || [];
        var brand = p.brand || '';
        var img = assetUrl(p.image) || '';
        var imgAlt = p.imageAlt || title;
        var href = (window.location.protocol === 'file:' ? 'equipment-product.html' : '/equipment/product') + '?id=' + encodeURIComponent(p.id);
        var hasPrice = p.price && String(p.price).trim();
        var currency = p.priceCurrency || '₽';
        var priceNum = hasPrice ? formatPrice(p.price) : '';
        var priceNote = p.priceNote || '';
        var chips = [];
        if (brand) chips.push('<span class="equipment-product-card__spec equipment-product-card__spec--brand">' + esc(brand) + '</span>');
        specs.forEach(function(s) { chips.push('<span class="equipment-product-card__spec">' + esc(s) + '</span>'); });
        var specsHtml = chips.length ? '<div class="equipment-product-card__specs">' + chips.join('') + '</div>' : '';
        var priceHtml;
        if (hasPrice) {
          priceHtml = '<div class="equipment-product-card__price">' + priceNum + '<span class="equipment-product-card__currency">' + esc(currency) + '</span></div>';
        } else {
          priceHtml = '<div class="equipment-product-card__price-request">Цена по запросу</div>' +
            (priceNote ? '<span class="equipment-product-card__price-note">' + esc(priceNote) + '</span>' : '');
        }
        return '<div class="equipment-product-card">' +
          '<div class="equipment-product-card__image">' +
            '<img src="' + esc(img) + '" alt="' + esc(imgAlt) + '" loading="lazy" />' +
          '</div>' +
          '<div class="equipment-product-card__body">' +
            '<h4 class="equipment-product-card__title">' + esc(title) + '</h4>' +
            (model ? '<p class="equipment-product-card__model">' + esc(model) + '</p>' : '') +
            specsHtml +
            '<div class="equipment-product-card__price-wrap">' + priceHtml + '</div>' +
            '<div class="equipment-product-card__actions">' +
              '<a href="#callback" class="equipment-product-card__cta">Уточнить и подобрать</a>' +
              '<a href="' + href + '" class="equipment-product-card__more">Подробнее</a>' +
            '</div>' +
          '</div>' +
        '</div>';
      }

      function getFilterVal(p, key, parsed) {
        if (key === 'brand') return p.brand || null;
        if (key === 'diameter') return parsed.diameter;
        if (key === 'connection') return parsed.connection;
        if (key === 'perf') return parsed.perf;
        if (key === 'type') return parsed.type;
        if (key === 'price') return p.price && String(p.price).trim() ? 'yes' : 'no';
        return null;
      }

      function matchesFilters(p, filters, parsed) {
        for (var k in filters) {
          if (!filters[k]) continue;
          if (getFilterVal(p, k, parsed) !== filters[k]) return false;
        }
        return true;
      }

      function sortProducts(list, sortBy, parsedMap) {
        var arr = list.slice();
        if (sortBy === 'price-asc') {
          arr.sort(function(a, b) {
            var pa = parseFloat(String(a.price || '').replace(/\s/g, '')) || Infinity;
            var pb = parseFloat(String(b.price || '').replace(/\s/g, '')) || Infinity;
            return pa - pb;
          });
        } else if (sortBy === 'price-desc') {
          arr.sort(function(a, b) {
            var pa = parseFloat(String(a.price || '').replace(/\s/g, '')) || 0;
            var pb = parseFloat(String(b.price || '').replace(/\s/g, '')) || 0;
            return pb - pa;
          });
        } else if (sortBy === 'perf') {
          arr.sort(function(a, b) {
            var pa = parseInt(parsedMap[a.id] && parsedMap[a.id].perf, 10) || 0;
            var pb = parseInt(parsedMap[b.id] && parsedMap[b.id].perf, 10) || 0;
            return pb - pa;
          });
        } else if (sortBy === 'brand') {
          arr.sort(function(a, b) {
            var aa = (a.brand || '').toLowerCase();
            var bb = (b.brand || '').toLowerCase();
            return aa.localeCompare(bb);
          });
        }
        return arr;
      }

      function render() {
        var cat = (new URLSearchParams(window.location.search).get('cat') || 'filtration').toLowerCase();
        var filters = {
          brand: document.getElementById('filter-brand') && document.getElementById('filter-brand').value || '',
          diameter: document.getElementById('filter-diameter') && document.getElementById('filter-diameter').value || '',
          connection: document.getElementById('filter-connection') && document.getElementById('filter-connection').value || '',
          perf: document.getElementById('filter-perf') && document.getElementById('filter-perf').value || ''
        };
        var sortBy = document.getElementById('sort-select') && document.getElementById('sort-select').value || 'popular';
        var products = window.EQUIPMENT_PRODUCTS || [];
        var list = products.filter(function(p) { return p.category === cat; });
        var parsedMap = {};
        list.forEach(function(p) { parsedMap[p.id] = parseProductFilters(p); });
        var filtered = list.filter(function(p) { return matchesFilters(p, filters, parsedMap[p.id]); });
        var sorted = sortProducts(filtered, sortBy, parsedMap);

        var grid = document.getElementById('grid-' + cat);
        var emptyEl = document.getElementById('empty-' + cat);
        if (grid) {
          grid.innerHTML = '';
          sorted.forEach(function(p) { grid.insertAdjacentHTML('beforeend', buildCard(p)); });
        }
        if (emptyEl) {
          emptyEl.style.display = sorted.length ? 'none' : 'block';
        }
        if (grid) grid.style.display = sorted.length ? '' : 'none';

        var countEl = document.getElementById('products-count');
        if (countEl) countEl.textContent = 'Найдено: ' + sorted.length;

        var chipsRow = document.getElementById('chips-row');
        var resetBtn = document.getElementById('chips-reset');
        if (chipsRow) {
          var active = Object.keys(filters).filter(function(k) { return filters[k]; });
          chipsRow.querySelectorAll('.equipment-catalog-chip').forEach(function(n) { n.remove(); });
          if (resetBtn) resetBtn.style.display = active.length ? 'inline' : 'none';
          var labels = { brand: 'Бренд', diameter: 'Ø', connection: 'Подкл.', perf: 'Пр-сть' };
          active.forEach(function(k) {
            var chip = document.createElement('span');
            chip.className = 'equipment-catalog-chip equipment-catalog-chip--active';
            var val = filters[k];
            chip.textContent = labels[k] + ': ' + val;
            chipsRow.appendChild(chip);
          });
        }
      }

      function fillFilterOptions(cat, products) {
        var list = products.filter(function(p) { return p.category === cat; });
        var parsedMap = {};
        list.forEach(function(p) { parsedMap[p.id] = parseProductFilters(p); });
        var brands = {}, diameters = {}, connections = {}, perfs = {};
        list.forEach(function(p) {
          var p0 = parsedMap[p.id];
          if (p.brand) brands[p.brand] = 1;
          if (p0.diameter) diameters[p0.diameter] = 1;
          if (p0.connection) connections[p0.connection] = 1;
          if (p0.perf) perfs[p0.perf] = 1;
        });
        function fillSel(id, opts, labels) {
          var sel = document.getElementById(id);
          if (!sel) return;
          var first = sel.querySelector('option');
          sel.innerHTML = first ? first.outerHTML : '';
          Object.keys(opts).sort().forEach(function(v) {
            var o = document.createElement('option');
            o.value = v;
            o.textContent = labels && labels[v] ? labels[v] : v;
            sel.appendChild(o);
          });
        }
        fillSel('filter-brand', brands);
        fillSel('filter-diameter', diameters);
        fillSel('filter-connection', connections);
        fillSel('filter-perf', perfs);
      }

      function runWith(categories, products) {
        categories = categories || {};
        products = products || [];
        var params = new URLSearchParams(window.location.search);
        var cat = (params.get('cat') || 'filtration').toLowerCase();
        if (!categories[cat]) {
          window.location.replace(window.location.protocol === 'file:' ? 'equipment.html' : '/equipment');
          return;
        }
        var title = categories[cat];
        document.title = title + ' — KALIPSO';
        var breadcrumbEl = document.getElementById('breadcrumb-category');
        var titleEl = document.getElementById('category-title');
        var subEl = document.getElementById('category-subtitle');
        if (breadcrumbEl) breadcrumbEl.textContent = title;
        if (titleEl) titleEl.textContent = title;
        if (subEl) subEl.textContent = subTitles[cat] || 'Оборудование для бассейнов.';
        var introTexts = { filtration: 'Как выбрать: подбор по объёму чаши и гидравлике трассы. Что влияет на цену: диаметр, материал корпуса, наличие насоса. Уточним бесплатно: совместимость с вашей схемой и актуальные сроки поставки.', heating: 'Как выбрать: мощность под объём и режим нагрева. Уточним бесплатно: теплообменник или электронагреватель, сроки.', automation: 'Как выбрать: под схему обвязки и задачи. Уточним бесплатно: совместимость и настройку.', attractions: 'Как выбрать: под объём чаши и сценарий. Уточним бесплатно: установку и совместимость.' };
        var introEl = document.getElementById('catalog-intro');
        if (introEl) { var t = introEl.querySelector('.equipment-catalog-intro__text'); if (t) t.textContent = introTexts[cat] || introTexts.filtration; }
        var stickyTexts = { filtration: 'Не уверены? Подберём фильтрацию под объём чаши за 15 минут.', heating: 'Подберём подогрев под объём и режим бассейна.', automation: 'Подберём автоматику и дозирование под вашу схему.', attractions: 'Подберём аттракционы под сценарий и бюджет.' };
        var stickyEl = document.getElementById('sticky-cta-text');
        if (stickyEl) stickyEl.textContent = stickyTexts[cat] || 'Не уверены? Подберём оборудование под объём чаши за 15 минут.';
        document.querySelectorAll('.equipment-catalog-page__products').forEach(function(p) {
          p.hidden = p.id !== 'products-' + cat;
        });
        fillFilterOptions(cat, products);
        render();

        ['filter-brand','filter-diameter','filter-connection','filter-perf','sort-select'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.addEventListener('change', render);
        });
        var toggleBtn = document.getElementById('filters-toggle');
        var filtersEl = document.getElementById('filters-sidebar');
        if (toggleBtn && filtersEl) {
          toggleBtn.addEventListener('click', function() {
            var open = filtersEl.classList.toggle('is-open');
            toggleBtn.setAttribute('aria-expanded', open);
          });
        }
        var resetBtn = document.getElementById('chips-reset');
        if (resetBtn) {
          resetBtn.addEventListener('click', function() {
            ['filter-brand','filter-diameter','filter-connection','filter-perf'].forEach(function(id) {
              var el = document.getElementById(id);
              if (el) el.value = '';
            });
            render();
          });
        }
      }

      if (API_BASE && typeof fetch === 'function') {
        fetch(API_BASE + '/api/equipment/all').then(function(r) { return r.ok ? r.json() : Promise.reject(); }).then(function(d) {
          runWith(d.categories, d.products);
        }).catch(function() {
          runWith(window.EQUIPMENT_CATEGORIES, window.EQUIPMENT_PRODUCTS);
        });
      } else {
        runWith(window.EQUIPMENT_CATEGORIES, window.EQUIPMENT_PRODUCTS);
      }
    })();
  </script>
</body>
</html>
