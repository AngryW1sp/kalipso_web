<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Оборудование — KALIPSO</title>
  <link rel="stylesheet" href="css/variables.css" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/product.css" />
  <link rel="stylesheet" href="css/catalog-hero.css" />
  <link rel="stylesheet" href="css/equipment-catalog.css" />
</head>
<body>
  <header class="header"></header>
  <script src="js/header.js"></script>
  <script src="js/url-rewrite.js"></script>

  <main class="product-page">
    <div class="container" id="product-content">
      <nav class="product-breadcrumb" id="breadcrumb"></nav>

      <div class="product-hero">
        <div class="product-hero__gallery">
          <div class="product-gallery__main">
            <img id="product-image" alt="" loading="lazy" />
          </div>
        </div>
        <aside class="product-buybox" id="buybox">
          <h1 class="product-buybox__title" id="product-title"></h1>
          <div class="buybox__price-block">
            <span class="buybox__price" id="product-price"></span>
            <span class="buybox__status" id="product-status"></span>
          </div>
          <a href="#callback" class="btn btn-gold callback__btn buybox__cta" id="product-cta">Перезвонить мне</a>
          <div class="buybox__specs" id="buybox-specs"></div>
          <div class="buybox__trust">
            <p>Гарантия на оборудование</p>
            <p>Подбор под ваш бассейн</p>
            <p>Консультация 15 минут</p>
          </div>
          <div class="buybox__docs" id="buybox-docs">
            <p class="buybox__docs-text">Паспорт и инструкция — пришлём по запросу.</p>
            <a href="#callback" class="btn btn-outline buybox__docs-btn">Запросить документы</a>
          </div>
        </aside>
      </div>

      <section class="product-about" id="product-about">
        <h2 class="product-section__title">Кратко</h2>
        <ul class="product-about__list" id="product-bullets"></ul>
      </section>

      <section class="product-includes" id="product-includes" style="display:none;">
        <h2 class="product-section__title">Что входит в комплект</h2>
        <ul class="product-about__list" id="product-includes-list"></ul>
      </section>

      <section class="product-specs-table" id="product-specs-section">
        <h2 class="product-section__title">Характеристики</h2>
        <div class="specs-table-wrap">
          <table class="specs-table" id="product-specs-table"></table>
        </div>
      </section>

      <section class="product-description-detail" id="product-detail">
        <h2 class="product-section__title">Подробно</h2>
        <div id="product-body" class="product-description"></div>
      </section>

      <section class="product-related" id="product-related">
        <h2 class="product-section__title">Похожие товары</h2>
        <div class="equipment-product-grid" id="related-grid"></div>
      </section>
    </div>
  </main>

  <section class="footer-cta callback callback--blue" id="callback">
    <div class="container">
      <div class="callback__glass">
        <div class="callback__text">
          <h2 class="callback__title">Остались вопросы?</h2>
          <p class="callback__desc">Оставьте контакты — перезвоним и ответим на вопросы по оборудованию.</p>
          <p class="callback__hint">Бесплатно. Перезвоним за 15 минут.</p>
        </div>
        <div class="callback__form-wrap">
          <form action="#" method="get" class="callback__form">
            <div class="callback__form-row">
              <input type="tel" name="phone" class="callback__input" placeholder="+7 (___) ___-__-__" required />
              <button type="submit" class="btn btn-gold callback__btn">Перезвонить мне</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="footer__grid">
        <div>
          <h4 class="footer__title">Каталог</h4>
          <ul class="footer__links">
            <li><a href="catalog.html">Бассейны</a></li>
            <li><a href="equipment.html">Оборудование</a></li>
          </ul>
        </div>
        <div>
          <h4 class="footer__title">Компания</h4>
          <ul class="footer__links">
            <li><a href="services.html">Услуги</a></li>
            <li><a href="about.html">О компании</a></li>
            <li><a href="contacts.html">Контакты</a></li>
          </ul>
        </div>
        <div>
          <h4 class="footer__title">Контакты</h4>
          <p style="margin:0;">+7 (495) 123-45-67</p>
          <p style="margin:4px 0 0;">info@kalipso.ru</p>
        </div>
      </div>
      <div class="footer__bottom">
        © 2025 KALIPSO. Проектирование и строительство бассейнов. Москва и область.
      </div>
    </div>
  </footer>
  <script src="data/equipment-products.js"></script>
  <script src="js/main.js"></script>
  <script src="js/lead-form.js"></script>
  <script>
    (function() {
      var API_BASE = window.EQUIPMENT_API_BASE !== undefined ? window.EQUIPMENT_API_BASE : 'http://127.0.0.1:8000';
      var params = new URLSearchParams(window.location.search);
      var id = params.get('id');

      function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatPrice(val) {
        if (!val) return '';
        var s = String(val).replace(/\s/g, '');
        return /^\d+$/.test(s) ? s.replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : val;
      }
      function parseSpecsTable(product) {
        if (product.specsTable && product.specsTable.length) return product.specsTable;
        var rows = [], seen = {};
        if (product.brand) { rows.push({ label: 'Бренд', value: product.brand }); seen['Бренд'] = 1; }
        if (product.model) { rows.push({ label: 'Модель', value: product.model }); seen['Модель'] = 1; }
        if (product.cardSpecs && product.cardSpecs.length) {
          product.cardSpecs.forEach(function(s) {
            var m = s.match(/Ø(\d+)\s*мм/);
            if (m && !seen['Диаметр']) { rows.push({ label: 'Диаметр', value: m[1] + ' мм' }); seen['Диаметр'] = 1; }
            else if (/Подкл\./i.test(s) && !seen['Подключение']) { rows.push({ label: 'Подключение', value: s.replace(/Подкл\.\s*/i, '').trim() }); seen['Подключение'] = 1; }
            else if (/м³\/ч/.test(s) && !seen['Производительность']) { rows.push({ label: 'Производительность', value: s }); seen['Производительность'] = 1; }
            else if (!seen[s]) { rows.push({ label: s, value: '—' }); seen[s] = 1; }
          });
        }
        if (product.specs && rows.length < 6) {
          product.specs.split('·').forEach(function(part) {
            var t = part.trim();
            if (t && !seen[t]) { rows.push({ label: t, value: '—' }); seen[t] = 1; }
          });
        }
        return rows;
      }
      function buildRelatedCard(p) {
        var title = p.shortTitle || p.title || '';
        var href = 'equipment-product.html?id=' + encodeURIComponent(p.id);
        var price = p.price && String(p.price).trim() ? formatPrice(p.price) + ' ' + (p.priceCurrency || '₽') : 'Цена по запросу';
        return '<a href="' + href + '" class="equipment-product-card">' +
          '<div class="equipment-product-card__image"><img src="' + escapeHtml(p.image || '') + '" alt="' + escapeHtml(p.imageAlt || title) + '" loading="lazy" /></div>' +
          '<div class="equipment-product-card__body">' +
            '<h4 class="equipment-product-card__title">' + escapeHtml(title) + '</h4>' +
            '<div class="equipment-product-card__price-wrap"><div class="equipment-product-card__price">' + escapeHtml(price) + '</div></div>' +
          '</div></a>';
      }

      function renderProduct(product, catName) {
        if (!product) { window.location.replace(window.location.protocol === 'file:' ? 'equipment.html' : '/equipment'); return; }
        var catSlug = product.category;
        if (!catName) catName = (window.EQUIPMENT_CATEGORIES || {})[catSlug] || catSlug;
        var catalogUrl = (window.location.protocol === 'file:' ? 'equipment-catalog.html' : '/equipment/catalog') + '?cat=' + encodeURIComponent(catSlug);

        document.title = (product.title || 'Товар') + ' — KALIPSO';
        document.getElementById('breadcrumb').innerHTML =
          '<a href="index.html">Главная</a> / <a href="equipment.html">Оборудование</a> / <a href="' + catalogUrl + '">' + escapeHtml(catName) + '</a> / ' + escapeHtml(product.title || '');

        document.getElementById('product-title').textContent = product.title || '';
        document.getElementById('product-image').src = product.image || '';
        document.getElementById('product-image').alt = product.imageAlt || product.title || '';

        var hasPrice = product.price && String(product.price).trim();
        var priceEl = document.getElementById('product-price');
        priceEl.textContent = hasPrice ? formatPrice(product.price) + ' ' + (product.priceCurrency || '₽') : 'Цена по запросу';

        var status = product.status || 'уточняем';
        document.getElementById('product-status').textContent = 'Статус: ' + status;

        document.getElementById('product-cta').textContent = 'Перезвонить мне';

        var specs = parseSpecsTable(product);
        var buyboxSpecs = document.getElementById('buybox-specs');
        if (specs.length) {
          buyboxSpecs.innerHTML = specs.slice(0, 5).map(function(r) {
            return '<span class="buybox__spec"><strong>' + escapeHtml(r.label) + '</strong> ' + escapeHtml(r.value) + '</span>';
          }).join('');
          buyboxSpecs.style.display = '';
        } else buyboxSpecs.style.display = 'none';

        var table = document.getElementById('product-specs-table');
        if (specs.length) {
          table.innerHTML = specs.map(function(r) {
            return '<tr class="specs-table__row"><td class="specs-table__label">' + escapeHtml(r.label) + '</td><td class="specs-table__value">' + escapeHtml(r.value) + '</td></tr>';
          }).join('');
          document.getElementById('product-specs-section').style.display = '';
        } else document.getElementById('product-specs-section').style.display = 'none';

        var bullets = product.shortBullets || (product.features && product.features.map(function(f) { return f.title + (f.text ? ' — ' + f.text : ''); })) || [];
        var bulletsEl = document.getElementById('product-bullets');
        if (bullets.length) {
          bulletsEl.innerHTML = bullets.map(function(b) { return '<li>' + escapeHtml(b) + '</li>'; }).join('');
          document.getElementById('product-about').style.display = '';
        } else document.getElementById('product-about').style.display = 'none';

        var includes = product.includes || (product.blocks && product.blocks.filter(function(b) { return b.type === 'features'; }).flatMap(function(b) { return (b.items || []).map(function(i) { return i.title + (i.text ? ' — ' + i.text : ''); }); })) || [];
        var includesEl = document.getElementById('product-includes-list');
        if (includes.length) {
          includesEl.innerHTML = includes.map(function(i) { return '<li>' + escapeHtml(i) + '</li>'; }).join('');
          document.getElementById('product-includes').style.display = '';
        }

        var body = document.getElementById('product-body');
        body.innerHTML = '';
        function addParagraphs(container, title, paragraphs) {
          if (!paragraphs || !paragraphs.length) return;
          var sec = document.createElement('section');
          sec.className = 'product-description__section';
          if (title) sec.innerHTML = '<h3 class="product-description__heading">' + escapeHtml(title) + '</h3>';
          paragraphs.forEach(function(para) {
            var p = document.createElement('p');
            p.className = 'product-description__text';
            p.textContent = para;
            sec.appendChild(p);
          });
          container.appendChild(sec);
        }
        if (product.blocks && product.blocks.length) {
          product.blocks.forEach(function(block) {
            if (block.type === 'about' && block.paragraphs && block.paragraphs.length) addParagraphs(body, block.title || '', block.paragraphs);
          });
        } else if (product.description && product.description.length) addParagraphs(body, '', product.description);
        document.getElementById('product-detail').style.display = body.children.length ? '' : 'none';

        var products = window.EQUIPMENT_PRODUCTS || [];
        var related = products.filter(function(p) { return p.category === catSlug && p.id !== product.id; }).slice(0, 4);
        var relatedGrid = document.getElementById('related-grid');
        if (related.length) {
          relatedGrid.innerHTML = related.map(buildRelatedCard).join('');
          document.getElementById('product-related').style.display = '';
        } else document.getElementById('product-related').style.display = 'none';
      }

      var products = window.EQUIPMENT_PRODUCTS || [];
      var p = id ? products.filter(function(x) { return x.id === id; })[0] : null;
      if (p) {
        renderProduct(p);
      } else if (id && API_BASE && typeof fetch === 'function') {
        fetch(API_BASE + '/api/equipment/' + encodeURIComponent(id)).then(function(r) { return r.ok ? r.json() : Promise.reject(); }).then(function(product) { renderProduct(product, product.categoryName); }).catch(function() { window.location.replace(window.location.protocol === 'file:' ? 'equipment.html' : '/equipment'); });
      } else {
        renderProduct(null);
      }
    })();
  </script>
</body>
</html>
